param workspace string

resource workspace_Microsoft_SecurityInsights_1a309966_0a7c_4707_a30e_6c170be09600 'Microsoft.OperationalInsights/workspaces/providers/alertRules@2023-12-01-preview' = {
  name: '${workspace}/Microsoft.SecurityInsights/1a309966-0a7c-4707-a30e-6c170be09600'
  kind: 'Scheduled'
  properties: {
    displayName: 'MXDR365 - Active Credential Harvesting - Stealer Malware Detection'
    description: 'This detection rule identifies active credential harvesting and data theft operations conducted through PowerShell-based stealer malware. The rule performs advanced behavioral analysis to detect malicious PowerShell scripts that specifically target browser credentials, password stores, wallet extensions, and user profile data for exfiltration. By monitoring for characteristic stealer malware terminology, operational status indicators, and data transmission patterns within short time windows, this detection catches sophisticated information stealer campaigns that target financial credentials, cryptocurrency wallets, and authentication data for subsequent fraud or unauthorized access activities.'
    severity: 'Medium'
    enabled: true
    query: 'DeviceEvents\r\n| where TimeGenerated > ago(1h)\r\n| where ActionType has "PowerShellCommand"\r\n| extend Commands = tostring(AdditionalFields.Command)\r\n| where isnotempty(Commands)\r\n// Process exclusions for noise reduction\r\n| where InitiatingProcessFileName !in~ ("pwsh.exe", "powershell_ise.exe") \r\n| where InitiatingProcessParentFileName !in~ ("explorer.exe", "cmd.exe")\r\n// Exclude common legitimate PowerShell operations\r\n| where not(Commands has_any(\r\n    "Test-Connection", "Get-EventLog", "Invoke-WebRequest", \r\n    "backup", "sync", "update", "Microsoft.PowerShell",\r\n    "ActiveDirectory", "Exchange", "AzureAD", "ImportExcel"\r\n))\r\n// Single logical detection filter\r\n| where (\r\n    // High confidence stealer indicators (standalone triggers)\r\n    Commands has_any("stealing", "Module: passwords", "Module: grabber", \r\n                    "wallet extensions", "password files", "LoginData.length")\r\n    \r\n    // OR medium confidence indicators WITH status confirmation\r\n    or (Commands has_any("Send-Message", "Send-Log", "Send-Data", \r\n                        "ProfileData", "BrowserName", "ProfileName", "archived to")\r\n        and Commands has_any("Status: ok", "Status: running", "Status: completed"))\r\n    \r\n    // OR size indicators WITH suspicious context\r\n    or (Commands contains "MB" \r\n        and Commands has_any("stealing", "archived to", "password files", "wallet"))\r\n)\r\n| summarize\r\n    Alert_Count = count(),\r\n    Theft_Operations = make_set(Commands, 20),\r\n    First_Activity = min(TimeGenerated),\r\n    Last_Activity = max(TimeGenerated),\r\n    Affected_Users = make_set(InitiatingProcessAccountName),\r\n    Session_Duration_Hours = datetime_diff(\'hour\', max(TimeGenerated), min(TimeGenerated)),\r\n    Unique_Processes = make_set(InitiatingProcessFileName),\r\n    Command_Variety = dcount(Commands)\r\n    by DeviceName\r\n| extend\r\n    Alert_Name = "ðŸ”´ CRITICAL: Active Credential Theft & Data Stealing",\r\n    Threat_Level = case(\r\n        Alert_Count >= 20, "CRITICAL - Persistent Stealing Campaign",\r\n        Alert_Count >= 10, "HIGH - Active Data Theft",\r\n        "MEDIUM - Credential Harvesting"\r\n    ),\r\n    MITRE_Technique = "T1555 - Credentials from Password Stores"\r\n// Quality filter - only alert on meaningful activity\r\n| where Alert_Count >= 2 or Command_Variety >= 2\r\n| project Alert_Name, Threat_Level, DeviceName, Alert_Count,\r\n    Session_Duration_Hours, Affected_Users, First_Activity, Last_Activity, \r\n    Theft_Operations, Unique_Processes, Command_Variety\r\n| order by Alert_Count desc'
    queryFrequency: 'PT1H'
    queryPeriod: 'PT1H'
    triggerOperator: 'GreaterThan'
    triggerThreshold: 0
    suppressionDuration: 'PT5H'
    suppressionEnabled: false
    startTimeUtc: null
    tactics: [
      'CredentialAccess'
      'Exfiltration'
    ]
    techniques: [
      'T1634'
      'T1041'
    ]
    subTechniques: []
    alertRuleTemplateName: null
    incidentConfiguration: {
      createIncident: true
      groupingConfiguration: {
        enabled: true
        reopenClosedIncident: false
        lookbackDuration: 'PT5H'
        matchingMethod: 'AllEntities'
        groupByEntities: []
        groupByAlertDetails: []
        groupByCustomDetails: []
      }
    }
    eventGroupingSettings: {
      aggregationKind: 'SingleAlert'
    }
    alertDetailsOverride: null
    customDetails: null
    entityMappings: [
      {
        entityType: 'Host'
        fieldMappings: [
          {
            identifier: 'HostName'
            columnName: 'DeviceName'
          }
        ]
      }
      {
        entityType: 'File'
        fieldMappings: [
          {
            identifier: 'Name'
            columnName: 'Unique_Processes'
          }
        ]
      }
      {
        entityType: 'Process'
        fieldMappings: [
          {
            identifier: 'CommandLine'
            columnName: 'Command_Variety'
          }
        ]
      }
    ]
    sentinelEntitiesMappings: null
    templateVersion: null
  }
}
